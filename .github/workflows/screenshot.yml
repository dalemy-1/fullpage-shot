name: screenshots

on:
  workflow_dispatch:
    inputs:
      url:
        description: "Target URL"
        required: true
        default: "http://154.48.226.95:802/#/"
      countries:
        description: "Countries (comma separated)"
        required: false
        default: "US,UK,DE,FR,IT,ES,CA,JP"
  schedule:
    - cron: "0 2 * * *"

permissions:
  contents: write

concurrency:
  group: screenshots-latest
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      WIDTH: "1440"
      HEIGHT: "3600"
      DPR: "3"
      URL: ${{ github.event.inputs.url || 'http://154.48.226.95:802/#/' }}
      COUNTRIES: ${{ github.event.inputs.countries || 'US,UK,DE,FR,IT,ES,CA,JP' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          sudo apt-get update
          # zip + 中文字体（关键）+ 常用字体
          sudo apt-get install -y --no-install-recommends zip fonts-noto-cjk fonts-noto-color-emoji
          npm ci || npm i
          npx playwright install --with-deps chromium

      - name: Run screenshots (grid)
        run: |
          rm -rf grid_all
          node ./multi_country_grid_4x5_v4.mjs "$URL" "grid_all"
          rm -f grid_all_latest.zip
          zip -r grid_all_latest.zip grid_all

      # 1) Actions artifact（你自己拿）
      - name: Upload Actions artifact
        uses: actions/upload-artifact@v4
        with:
          name: grid_all_latest
          path: grid_all_latest.zip
          if-no-files-found: error

      # 2) Release（同事免登录下载固定链接）
      - name: Create/Update Release (latest)
        uses: ncipollo/release-action@v1
        with:
          tag: latest
          name: Latest build
          allowUpdates: true
          replacesArtifacts: true
          artifacts: "grid_all_latest.zip"
          token: ${{ secrets.GITHUB_TOKEN }}
